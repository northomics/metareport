---
title: "Peptide identification Quick summary"
author: Suggestions to imetalabca@gmail.com
date: Report generated @`r Sys.time()`
always_allow_html: TRUE
output:
  html_document:
    fig_width: 10
    fig_caption: TRUE
    toc: TRUE
    toc_depth: 4
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
    number_sections: TRUE
  pdf_document:
    toc: true
    toc_depth: 4
    highlight: tango
    df_print: kable
    number_sections: TRUE
  word_document:
    toc: true
    toc_depth: 4
    highlight: tango
    df_print: kable
    smart: TRUE
params:  
  data_table: !r NULL ### Manditory; main data input for the report
  meta_table: !r NULL ### Optional; If provided, will do some statistics
  if_html: TRUE # if you want to pdf or word export, set this as FALSE
---

<style type="text/css">
.main-container {
  max-width: 1400px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r, echo=FALSE}
htmltools::img(src = "https://gitlab.com/iMetaLab/rmdocpu/-/raw/master/iMetaReport.png", 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;width:100px;height:100px;')
```



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE, cache = FALSE)

library(tidyverse)
library(ggplot2)
library(plotly)
library(rmetalab)
library(gplots)
library(rhandsontable)

```


```{r tidy_file, echo=FALSE, error=TRUE}

# collect input
data_table <- params$data_table
meta_table <- params$meta_table 

# tidy and process:
peptide_tidyed <- tidy_peptide_table(data_table)
df_intensity <- peptide_tidyed$intensity_matrix
rownames(df_intensity) <- peptide_tidyed$peptide_sequence

# Q100 peptides (peptide with 100 presence across samples) for quick profiing, includidng heatmap and PCA analysis
sparsity <- rowSums(df_intensity > 0) # here sparsity is number of valid values in each row

index_Q100 <- which(sparsity == ncol(df_intensity)) # index_Q100 is the index of Q100 peptide
df_intensity_Q100 <- df_intensity[index_Q100, , drop = FALSE] # the Q100 peptide intensity matrix
df_intensity_Q100_log10 <- log10(as.matrix(df_intensity_Q100))
peptide_sequence_Q100 <- peptide_sequence[index_Q100]

# remove rows without any quantification information (all 0 )
index_all_na_rows <- which(sparsity == 0)
df_intensity <- df_intensity[-index_all_na_rows,,drop = FALSE]
peptide_sequence <- peptide_tidyed$peptide_sequence[-index_all_na_rows]

# this figure_height is for very tight figures with a lot of samples
figure_height <- 0.1*ncol(df_intensity)+4

```



```{r check_meta, echo=FALSE, error=TRUE}

# check meta_table
if( is.null(meta_table)){ 
  meta_info <- "* **No meta information provided**"
  
}else if (any(is.na(meta_table))){ 
  
  meta_info <-  "* **The meta information provided has missing values, please check, analysis continues without grouping information**"
  meta_table <- NULL
  
}else if(!identical(sort(peptide_tidyed$experiment),sort(meta_table[,2]))){
  meta_info <-  "* **The raw files in meta information provided do not match the raw file names in the data file, please check, analysis continues without grouping information**"
  meta_table <- NULL

}else{
  
  meta_table <- meta_table[match(colnames(df_intensity),meta_table$Experiment),] # ensure the order is the same is the column names
  meta_info <- NULL
  # numerate all meta info
  for(i in 3: ncol(meta_table)){
     meta_info <-   paste0(meta_info, "* **Grouping ",i-2,": **" , paste0(unique(meta_table[,i]), collapse="; "), "<br>  \n\n" )  
  }
}

```


# Intro

**This report provides some basic description of the peptide identificaiton from database search. **

**This report can be used to quickly check the overal quality of the experiment**



# Quick Message

*  **Number of qualified peptides: ** `r nrow(peptide_tidyed$intensity_matrix)`

*  **Number of quailfied peptide without intensity information(0 intensitiy):  ** `r length(index_all_na_rows)`

*  **Number of experiment:  ** `r ncol(df_intensity)`

*  **All experiments:  ** `r colnames(df_intensity)`

`r meta_info` 


<!-- # Peptide property profiling  {.tabset .tabset-fade } -->


```{r, echo=FALSE, results='asis', error=TRUE, eval= FALSE}
# profiling section of the peptide sequence identified
res <- knitr::knit_child('MQ_report_peptides_child1_profile.Rmd', envir = environment(), quiet = TRUE)
cat(res, sep = '\n')

```

<!-- # Heatmap Profiling {.tabset .tabset-fade } -->

```{r, echo=FALSE, results='asis', error=TRUE, eval= FALSE}
# heatamap, only if the quantification matrix has more than 1 columns 

if(ncol(df_intensity) > 1){
  res <- knitr::knit_child('MQ_report_peptides_child2_heatmap.Rmd',quiet = TRUE) # envir = environment(), 
  cat(res, sep = '\n')
}else{
  print("There is only one column/experiment, no heatmap export!")
}

```


<!-- # PCA Analysis -->


```{r, echo=FALSE, results='asis', error=TRUE, eval= FALSE}
# heatamap, only if the quantification matrix has more than 3 columns, otherewise no point of doing PCA

if(ncol(df_intensity) > 3){
  
  section_title <- "No Grouping"
  #no_grouping <- "TRUE"
  
  res <- knitr::knit_child('MQ_report_peptides_child3_PCA_nogrouping.Rmd', quiet = TRUE)
  cat(res, sep = '\n')
  
  
  # for extra plot with grouping information
  if(!is.null(meta_table)){
    for(i in 3: ncol(meta_table)){ # i is the column index
       section_title<- paste0("Grouping: " , paste0(unique(meta_table[,i]), collapse="; ") )
       #no_grouping <- "FALSE"
       res <- knitr::knit_child('MQ_report_peptides_child3_PCA_grouping.Rmd', quiet = TRUE)
       cat(res, sep = '\n')
   }
  }
  
}

```


<!-- Differntial Analysis -->
# Differential Analysis {.tabset .tabset-fade }



```{r echo=FALSE,results='asis', error=TRUE, eval= TRUE}
  # for extra plot with grouping information
  if(!is.null(meta_table)){
    for(i in 3: ncol(meta_table)){ # i is the column index
       section_title<- paste0("Grouping: " , paste(unique(meta_table[,i]), collapse="; ") )
       
       
       
       if(length(unique(meta_table[,i])) >=2  && all(table(meta_table[,i]) >=2)){
         # will do ANOVA analysis block while: 
         # 1: more than (including) 3 groups, 2: each group has more than (includeing) 2 samples.
            res <- knitr::knit_child('MQ_report_peptides_child4_ANOVA.Rmd', quiet = TRUE)
            cat(res, sep = '\n')
       }
       
       

   }
  }
  


```



